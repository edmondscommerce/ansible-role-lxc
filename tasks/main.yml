- name: install required packages
  package:
    name:
      - epel-release
      - wget
    state: present

- name: add copr repo for lxc
  include_role:
    name: edmondscommerce.copr-repository
  vars:
    copr_repository_action: install
    copr_repository: thm/lxc2.0
    #copr_repository: ganto/lxc3

- name: install lxc
  package:
    name:
      - python2-lxc
      - lxc
      - lxc-templates
      - libvirt
    state: present

- name: enable lxc and libvirt on systemd
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  with_items:
    - lxc
    - libvirtd

- name: configure lxc defaults
  template:
    src: default.conf
    dest: /etc/lxc/default.conf

#- name: install squid for yum caching
#  package:
#    name: squid
#    state: present
#
#- name: set up squid filesystem cache
#  shell: >
#    echo "cache_dir ufs /var/spool/squid 7000 16 256" >> /etc/squid/squid.conf;
#  args:
#    executable: /bin/bash
#
#- name: start and enable squid
#  systemd:
#    name: squid
#    state: started
#    enabled: yes

- name: create LXC containers in inventory
  lxc_container:
    name: "{{ item }}"
    template: download
    state: started
    backing_store: dir
    fs_size: 4G
    template_options: --dist centos --release 7 --arch amd64
    #configuring yum to use the squid proxy on the container host
#    container_command: |
#      echo "proxy=http://$(ip r | grep default | cut -d ' ' -f 3 | xargs):3128" >> /etc/yum.conf;
#      sed -i 's/^mirror/#mirror/g' /etc/yum.repos.d/CentOS-Base.repo;
#      sed -i 's/^#base/base/g' /etc/yum.repos.d/CentOS-Base.repo;

  with_items: "{{ groups['lxc'] }}"

- name: set up some bash completion - ensure package is installed
  package:
    name:
      - bash-completion
    state: present

- name: set up some bash completion - copy template in
  template:
    src: lxcBashCompletion.inc.bash
    dest: /etc/bash_completion.d/lxcBashCompletion.inc.bash



